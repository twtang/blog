<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="TW">
<meta name="dcterms.date" content="2025-03-29">

<title>Q8. Recommendaton System (18 points) – Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-6bd9cfa162949bde0a231f530c97869d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Q8. Recommendaton System (18 points)</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">python</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>TW </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 29, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="q8.-recommendaton-system-18-points" class="level2">
<h2 class="anchored" data-anchor-id="q8.-recommendaton-system-18-points">Q8. Recommendaton System (18 points)</h2>
<p>You have learned some basic models including user-based and item-based collaborative filtering methods in class. However, some features of items or users can also help to improve the performance of recommendation system.</p>
<p>In this question, you are given a movie rating dataset which contains basic rating information, movie titles, movie genres and user information. You should try to figure out how to utilize these features to construct a recommendation system.</p>
<p><strong>You need to:</strong></p>
<p>Based on rating_train.csv and other relevant data in this question, build a recommendation system to predict user ratings for movies in rating_test.csv.</p>
<p><strong>Data Descriptions:</strong> 1. Data is in Data_Q8 folder. 2. Data descriptions are shown in Data_Q8.</p>
<p><strong>Submissions :</strong> 1. Put all you codes in Q8_code folder. 2. Your prediction result named as Q8_output.csv . ( Notes: Each line represents the user’s rating of the movie, which means your final output should contain 3 columns: ‘UserID’, ‘MovieID’ and ‘Rating’)</p>
<p><strong>Bonus:</strong></p>
<p>There will be some bonus score if you use some creative or the state-of-arts models. Please report the advantages of your methods and list all your references in Q8_readme.pdf.</p>
<div id="cell-2" class="cell" data-outputid="73a1fa3b-26f5-4381-8f18-0b246f4ff516" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>cd <span class="op">/</span>content<span class="op">/</span>drive<span class="op">/</span>MyDrive<span class="op">/</span>Notes<span class="op">/</span>MSBD5002<span class="op">/</span>Data_Q8</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/content/drive/MyDrive/Notes/MSBD5002/Data_Q8</code></pre>
</div>
</div>
<div id="cell-3" class="cell" data-outputid="33d22121-8fe6-4ecc-e308-69224ca6e90c">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>Uqq fastai</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 363.4/363.4 MB 3.8 MB/s eta 0:00:00
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 13.8/13.8 MB 42.0 MB/s eta 0:00:00
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 24.6/24.6 MB 30.0 MB/s eta 0:00:00
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 883.7/883.7 kB 42.7 MB/s eta 0:00:00
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 664.8/664.8 MB 1.8 MB/s eta 0:00:00
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 211.5/211.5 MB 5.0 MB/s eta 0:00:00
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 56.3/56.3 MB 9.8 MB/s eta 0:00:00
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 127.9/127.9 MB 7.4 MB/s eta 0:00:00
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 207.5/207.5 MB 7.3 MB/s eta 0:00:00
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 21.1/21.1 MB 64.5 MB/s eta 0:00:00</code></pre>
</div>
</div>
<p>Let’s tackle Q8, which involves building a recommendation system to predict user ratings for movies using the Fastai framework. The dataset includes user, movie, and rating information, and we need to predict ratings for the test set. The output should be in <code>Q8_output.csv</code> with columns <code>UserID</code>, <code>MovieID</code>, and <code>Rating</code>, and the code and report should be submitted in <code>Q8_readme.pdf</code> in a folder named <code>Q8</code>. Let’s break this down step by step.</p>
<section id="step-1-understanding-the-problem-and-data" class="level3">
<h3 class="anchored" data-anchor-id="step-1-understanding-the-problem-and-data">Step 1: Understanding the Problem and Data</h3>
<ul>
<li><strong>Data Description</strong>:
<ul>
<li><strong>users.csv</strong>: Contains user information.
<ul>
<li>Columns: <code>UserID</code>, <code>Gender</code>, <code>Age</code>, <code>OccupationID</code>, <code>zip-code</code>.</li>
<li>UserIDs range from 1 to 6040.</li>
</ul></li>
<li><strong>movies.csv</strong>: Contains movie information.
<ul>
<li>Columns: <code>MovieID</code>, <code>Title</code>, <code>Genres</code>.</li>
<li>MovieIDs range from 1 to 3952.</li>
</ul></li>
<li><strong>rating_train.csv</strong>: Contains training ratings.
<ul>
<li>Columns: <code>UserID</code>, <code>MovieID</code>, <code>timestamps</code>, <code>Rating</code>.</li>
<li>Ratings are on a 5-star scale (whole numbers).</li>
<li>Each user has at least 20 ratings.</li>
</ul></li>
<li><strong>rating_test.csv</strong>: Contains test data for which we need to predict ratings.
<ul>
<li>Columns: <code>UserID</code>, <code>MovieID</code>, <code>timestamps</code>.</li>
</ul></li>
</ul></li>
<li><strong>Task</strong>:
<ul>
<li>Build a recommendation system to predict ratings in <code>rating_test.csv</code>.</li>
<li>Output predictions in <code>Q8_output.csv</code> with columns <code>UserID</code>, <code>MovieID</code>, <code>Rating</code>.</li>
<li>Submit the code and report in <code>Q8_readme.pdf</code> in a folder named <code>Q8</code>.</li>
</ul></li>
<li><strong>Bonus</strong>: Use creative or state-of-the-art methods to improve performance.</li>
</ul>
<section id="approach" class="level4">
<h4 class="anchored" data-anchor-id="approach">Approach</h4>
<p>We’ll use Fastai’s collaborative filtering module (<code>collab_learner</code>), which is designed for recommendation systems. Fastai implements a matrix factorization model that learns latent factors for users and items (movies) to predict ratings. We’ll: 1. Load and preprocess the data. 2. Use Fastai’s <code>collab_learner</code> to train a collaborative filtering model. 3. Predict ratings for the test set. 4. Enhance the model by incorporating user and movie features (e.g., genres, user demographics) for the bonus points.</p>
</section>
</section>
<section id="step-2-preprocessing-the-data" class="level3">
<h3 class="anchored" data-anchor-id="step-2-preprocessing-the-data">Step 2: Preprocessing the Data</h3>
<p>We’ll load the data and prepare it for Fastai’s collaborative filtering module.</p>
<section id="step-2.1-load-the-data" class="level4">
<h4 class="anchored" data-anchor-id="step-2.1-load-the-data">Step 2.1: Load the Data</h4>
<div id="cell-9" class="cell" data-outputid="c9118ba4-c55c-4e4f-d49c-9cc04af3f1ef" data-execution_count="2">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.collab <span class="im">import</span> <span class="op">*</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.torch_core <span class="im">import</span> <span class="op">*</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>users <span class="op">=</span> pd.read_csv(<span class="st">'users.csv'</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>movies <span class="op">=</span> pd.read_csv(<span class="st">'movies.csv'</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>ratings_train <span class="op">=</span> pd.read_csv(<span class="st">'rating_train.csv'</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>ratings_test <span class="op">=</span> pd.read_csv(<span class="st">'rating_test.csv'</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Users:"</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>display_df(users.head())</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Movies:"</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>display_df(movies.head())</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Training Ratings:"</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>display_df(ratings_train.head())</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Test Ratings:"</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>display_df(ratings_test.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Users:</code></pre>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">UserID</th>
<th data-quarto-table-cell-role="th">Gender</th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">OccupationID</th>
<th data-quarto-table-cell-role="th">Zip-code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>F</td>
<td>1</td>
<td>10</td>
<td>48067</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>M</td>
<td>56</td>
<td>16</td>
<td>70072</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>M</td>
<td>25</td>
<td>15</td>
<td>55117</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>M</td>
<td>45</td>
<td>7</td>
<td>02460</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>M</td>
<td>25</td>
<td>20</td>
<td>55455</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Movies:</code></pre>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">MovieID</th>
<th data-quarto-table-cell-role="th">Title</th>
<th data-quarto-table-cell-role="th">Genres</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>Toy Story (1995)</td>
<td>Animation|Children's|Comedy</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>Jumanji (1995)</td>
<td>Adventure|Children's|Fantasy</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>Grumpier Old Men (1995)</td>
<td>Comedy|Romance</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>Waiting to Exhale (1995)</td>
<td>Comedy|Drama</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>Father of the Bride Part II (1995)</td>
<td>Comedy</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Training Ratings:</code></pre>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">UserID</th>
<th data-quarto-table-cell-role="th">MovieID</th>
<th data-quarto-table-cell-role="th">timestamps</th>
<th data-quarto-table-cell-role="th">Rating</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>1836</td>
<td>978300172</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>1097</td>
<td>978301953</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>2028</td>
<td>978301619</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1</td>
<td>527</td>
<td>978824195</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1</td>
<td>2918</td>
<td>978302124</td>
<td>4</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Test Ratings:</code></pre>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">UserID</th>
<th data-quarto-table-cell-role="th">MovieID</th>
<th data-quarto-table-cell-role="th">timestamps</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>914</td>
<td>978301968</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>2018</td>
<td>978301777</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>2797</td>
<td>978302039</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1</td>
<td>1270</td>
<td>978300055</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1</td>
<td>1545</td>
<td>978824139</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="step-2.2-prepare-the-data-for-collaborative-filtering" class="level4">
<h4 class="anchored" data-anchor-id="step-2.2-prepare-the-data-for-collaborative-filtering">Step 2.2: Prepare the Data for Collaborative Filtering</h4>
<p>Fastai’s <code>collab_learner</code> expects a DataFrame with columns <code>user</code>, <code>item</code>, and <code>rating</code>. We’ll rename the columns in <code>ratings_train</code> accordingly.</p>
<div id="cell-11" class="cell" data-outputid="bc64b842-1520-4d71-cae8-d5dd3eb444e1" data-execution_count="3">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename columns for Fastai</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ratings_train = ratings_train.rename(columns={'UserID': 'user', 'MovieID': 'item', 'Rating': 'rating'})</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>ratings_train <span class="op">=</span> ratings_train[[<span class="st">'UserID'</span>, <span class="st">'MovieID'</span>, <span class="st">'Rating'</span>]]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>display_df(ratings_train.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">UserID</th>
<th data-quarto-table-cell-role="th">MovieID</th>
<th data-quarto-table-cell-role="th">Rating</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>1836</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>1097</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>2028</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1</td>
<td>527</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1</td>
<td>2918</td>
<td>4</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="step-3-train-the-model-with-fastai" class="level3">
<h3 class="anchored" data-anchor-id="step-3-train-the-model-with-fastai">Step 3: Train the Model with Fastai</h3>
<p>We’ll use Fastai’s <code>collab_learner</code> to train a collaborative filtering model.</p>
<section id="step-3.1-create-a-dataloaders-object" class="level4">
<h4 class="anchored" data-anchor-id="step-3.1-create-a-dataloaders-object">Step 3.1: Create a DataLoaders Object</h4>
<ul>
<li><strong>CollabDataLoaders</strong>: Loads the data for collaborative filtering.</li>
<li><strong>Parameters</strong>:
<ul>
<li><code>user_name</code>, <code>item_name</code>, <code>rating_name</code>: Column names for users, items, and ratings.</li>
<li><code>bs</code>: Batch size of 64.</li>
</ul></li>
</ul>
<div id="cell-14" class="cell" data-outputid="9711495c-0cae-4c26-edc2-ecd53ea3ac3a" data-execution_count="5">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a CollabDataLoaders object</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> CollabDataLoaders.from_df(ratings_train, user_name<span class="op">=</span><span class="st">'UserID'</span>, item_name<span class="op">=</span><span class="st">'MovieID'</span>, rating_name<span class="op">=</span><span class="st">'Rating'</span>, bs<span class="op">=</span><span class="dv">64</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Display a batch</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">UserID</th>
<th data-quarto-table-cell-role="th">MovieID</th>
<th data-quarto-table-cell-role="th">Rating</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>426</td>
<td>2580</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>621</td>
<td>1128</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2148</td>
<td>1438</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1563</td>
<td>2997</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>29</td>
<td>1204</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>3826</td>
<td>1197</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>5664</td>
<td>2571</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>825</td>
<td>3095</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2683</td>
<td>802</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>4064</td>
<td>1801</td>
<td>2</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="step-3.2-train-the-model" class="level4">
<h4 class="anchored" data-anchor-id="step-3.2-train-the-model">Step 3.2: Train the Model</h4>
<ul>
<li><strong>collab_learner</strong>:
<ul>
<li><code>n_factors=50</code>: Number of latent factors for users and items.</li>
<li><code>y_range=(0.5, 5.5)</code>: Ratings are between 1 and 5, but we allow a slightly wider range for the sigmoid output.</li>
</ul></li>
<li><strong>fit_one_cycle</strong>:
<ul>
<li>Trains for 5 epochs with a learning rate of 5e-3 and weight decay of 0.1.</li>
</ul></li>
</ul>
<div id="cell-16" class="cell" data-outputid="2a44b618-2d4c-4ee4-8306-34b3aaac64ca" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a collaborative filtering learner</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> collab_learner(dls, n_factors<span class="op">=</span><span class="dv">50</span>, y_range<span class="op">=</span>(<span class="fl">0.5</span>, <span class="fl">5.5</span>))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Find an optimal learning rate</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>SuggestedLRs(valley=0.013182567432522774)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Q8_code_files/figure-html/cell-7-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-17" class="cell" data-outputid="13c9745e-8175-4122-9848-8545a9c8a9a7" data-execution_count="7">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the model</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>, <span class="fl">5e-3</span>, wd<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.888834</td>
<td>0.900303</td>
<td>01:00</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.792929</td>
<td>0.874477</td>
<td>01:02</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.765064</td>
<td>0.838958</td>
<td>01:00</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.720110</td>
<td>0.795160</td>
<td>01:03</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.712781</td>
<td>0.781255</td>
<td>01:08</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="step-4-predict-on-the-test-set" class="level3">
<h3 class="anchored" data-anchor-id="step-4-predict-on-the-test-set">Step 4: Predict on the Test Set</h3>
<p>We’ll use the trained model to predict ratings for the test set.</p>
<ul>
<li><strong>test_dl</strong>: Creates a test DataLoader for the test set.</li>
<li><strong>get_preds</strong>: Predicts ratings for the test set.</li>
<li><strong>Rounding</strong>: Rounds predictions to the nearest integer and clips them to the range [1, 5].</li>
</ul>
<div id="cell-19" class="cell" data-outputid="65cafdb3-c2e4-49a8-c42f-3c07c5a98ca9">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the test set</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>test_dl <span class="op">=</span> dls.test_dl(ratings_test)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict ratings</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>preds, _ <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>test_dl)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>ratings_test[<span class="st">'Rating'</span>] <span class="op">=</span> preds.numpy()</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Round predictions to the nearest integer (since ratings are whole numbers)</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>ratings_test[<span class="st">'Rating'</span>] <span class="op">=</span> ratings_test[<span class="st">'Rating'</span>].<span class="bu">round</span>().clip(<span class="dv">1</span>, <span class="dv">5</span>).astype(<span class="bu">int</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the output DataFrame</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>output_df <span class="op">=</span> ratings_test[[<span class="st">'UserID'</span>, <span class="st">'MovieID'</span>, <span class="st">'Rating'</span>]]</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to CSV</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>output_df.to_csv(<span class="st">'Q8_output.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
</section>
</section>
<section id="step-5-using-additional-features" class="level2">
<h2 class="anchored" data-anchor-id="step-5-using-additional-features">Step 5: Using Additional Features</h2>
<p>Let’s enhance the movie recommendation system by incorporating additional features like <code>Age</code>, <code>Genres</code>, <code>OccupationID</code>, and <code>Zipcode</code> into the model. These features can provide more context about users and movies, potentially improving the prediction accuracy. Since FastAI’s <code>collab_learner</code> is primarily designed for collaborative filtering (using only user and item IDs), we’ll need to take a hybrid approach by combining collaborative filtering with content-based features. We can achieve this by preprocessing the data and using a custom model in FastAI that incorporates these additional features.</p>
<section id="step-5.1-understanding-the-additional-features" class="level3">
<h3 class="anchored" data-anchor-id="step-5.1-understanding-the-additional-features">Step 5.1: Understanding the Additional Features</h3>
<ul>
<li><strong>users.csv</strong>: Contains <code>UserID</code>, <code>Gender</code>, <code>Age</code>, <code>OccupationID</code>, and <code>Zip-code</code>.
<ul>
<li><code>Age</code>: Numerical (e.g., 1, 18, 25, etc.).</li>
<li><code>OccupationID</code>: Categorical (e.g., 0 to 20).</li>
<li><code>Zip-code</code>: Categorical (e.g., “48067”).</li>
<li><code>Gender</code>: Categorical (e.g., “M”, “F”).</li>
</ul></li>
<li><strong>movies.csv</strong>: Contains <code>MovieID</code>, <code>Title</code>, and <code>Genres</code>.
<ul>
<li><code>Genres</code>: Multiple genres per movie (e.g., “Animation|Children’s”).</li>
</ul></li>
</ul>
<p>We’ll preprocess these features: - <strong>Genres</strong>: Split the multi-label genres into binary columns (one-hot encoding for each genre). - <strong>Zip-code</strong>: Extract the first 3 digits (to reduce cardinality) and treat it as a categorical feature. - <strong>Age</strong>, <strong>OccupationID</strong>, <strong>Gender</strong>: Treat as categorical features (FastAI will embed them).</p>
</section>
<section id="step-5.2-preprocessing-the-data" class="level3">
<h3 class="anchored" data-anchor-id="step-5.2-preprocessing-the-data">Step 5.2: Preprocessing the Data</h3>
<p>We’ll merge the additional features into the training and test datasets and preprocess them for use in a hybrid model.</p>
<section id="preprocessing-code" class="level4">
<h4 class="anchored" data-anchor-id="preprocessing-code">Preprocessing Code</h4>
<div id="cell-23" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.collab <span class="im">import</span> <span class="op">*</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.tabular.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the datasets</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> pd.read_csv(<span class="st">'rating_train.csv'</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.read_csv(<span class="st">'rating_test.csv'</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>users_df <span class="op">=</span> pd.read_csv(<span class="st">'users.csv'</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>movies_df <span class="op">=</span> pd.read_csv(<span class="st">'movies.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-24" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Preprocess Users Data ---</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract first 3 digits of Zipcode to reduce cardinality</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>users_df[<span class="st">'Zip-code'</span>] <span class="op">=</span> users_df[<span class="st">'Zip-code'</span>].<span class="bu">str</span>[:<span class="dv">3</span>]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Age, OccupationID, Gender, and Zipcode to categorical</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>users_df[<span class="st">'Age'</span>] <span class="op">=</span> users_df[<span class="st">'Age'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>users_df[<span class="st">'OccupationID'</span>] <span class="op">=</span> users_df[<span class="st">'OccupationID'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>users_df[<span class="st">'Gender'</span>] <span class="op">=</span> users_df[<span class="st">'Gender'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>users_df[<span class="st">'Zip-code'</span>] <span class="op">=</span> users_df[<span class="st">'Zip-code'</span>].astype(<span class="st">'category'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-25" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Preprocess Movies Data ---</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Split genres into a list</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>movies_df[<span class="st">'Genres'</span>] <span class="op">=</span> movies_df[<span class="st">'Genres'</span>].<span class="bu">str</span>.split(<span class="st">'|'</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get all unique genres</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>all_genres <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> genres <span class="kw">in</span> movies_df[<span class="st">'Genres'</span>]:</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    all_genres.update(genres)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>all_genres <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">list</span>(all_genres))</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create binary columns for each genre</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> genre <span class="kw">in</span> all_genres:</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    movies_df[genre] <span class="op">=</span> movies_df[<span class="st">'Genres'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> genre <span class="kw">in</span> x <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop the original Genres column</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>movies_df <span class="op">=</span> movies_df.drop(columns<span class="op">=</span>[<span class="st">'Genres'</span>, <span class="st">'Title'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-26" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Merge Features into Train and Test Data ---</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge user features</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> train_df.merge(users_df, on<span class="op">=</span><span class="st">'UserID'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> test_df.merge(users_df, on<span class="op">=</span><span class="st">'UserID'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge movie features</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> train_df.merge(movies_df, on<span class="op">=</span><span class="st">'MovieID'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> test_df.merge(movies_df, on<span class="op">=</span><span class="st">'MovieID'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure all categorical columns are treated as categories</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>cat_cols <span class="op">=</span> [<span class="st">'UserID'</span>, <span class="st">'MovieID'</span>, <span class="st">'Gender'</span>, <span class="st">'Age'</span>, <span class="st">'OccupationID'</span>, <span class="st">'Zip-code'</span>]</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> cat_cols:</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    train_df[col] <span class="op">=</span> train_df[col].astype(<span class="st">'category'</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    test_df[col] <span class="op">=</span> test_df[col].astype(<span class="st">'category'</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Continuous columns (genre binary features are already 0/1)</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>cont_cols <span class="op">=</span> all_genres  <span class="co"># The genre columns are binary but treated as continuous</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>dep_var <span class="op">=</span> <span class="st">'Rating'</span>  <span class="co"># Dependent variable</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="explanation-of-preprocessing" class="level4">
<h4 class="anchored" data-anchor-id="explanation-of-preprocessing">Explanation of Preprocessing</h4>
<ol type="1">
<li><strong>Users Data</strong>:
<ul>
<li><code>Zip-code</code>: Reduced cardinality by taking the first 3 digits (e.g., “48067” → “480”).</li>
<li><code>Age</code>, <code>OccupationID</code>, <code>Gender</code>, <code>Zipcode</code>: Converted to categorical variables for embedding.</li>
</ul></li>
<li><strong>Movies Data</strong>:
<ul>
<li><code>Genres</code>: Split into binary columns (e.g., <code>Animation</code>, <code>Comedy</code>, etc.) using one-hot encoding.</li>
<li>Dropped <code>Title</code> and <code>Genres</code> columns after processing.</li>
</ul></li>
<li><strong>Merging</strong>:
<ul>
<li>Merged user features (<code>Gender</code>, <code>Age</code>, <code>OccupationID</code>, <code>Zipcode</code>) into the train/test data using <code>UserID</code>.</li>
<li>Merged movie features (genre binary columns) into the train/test data using <code>MovieID</code>.</li>
</ul></li>
<li><strong>Categorical and Continuous Columns</strong>:
<ul>
<li>Categorical: <code>UserID</code>, <code>MovieID</code>, <code>Gender</code>, <code>Age</code>, <code>OccupationID</code>, <code>Zip-code</code>.</li>
<li>Continuous: Genre binary columns (e.g., <code>Animation</code>, <code>Comedy</code>).</li>
</ul></li>
</ol>
</section>
</section>
<section id="step-5.3-build-a-hybrid-model-with-fastai" class="level3">
<h3 class="anchored" data-anchor-id="step-5.3-build-a-hybrid-model-with-fastai">Step 5.3: Build a Hybrid Model with FastAI</h3>
<p>FastAI’s <code>collab_learner</code> doesn’t directly support additional features, so we’ll use a tabular model (<code>tabular_learner</code>) with embeddings for categorical variables and continuous features for the genre columns. We’ll create a custom dataset that combines collaborative filtering (user-movie interactions) with the additional features.</p>
<section id="code-for-hybrid-model" class="level4">
<h4 class="anchored" data-anchor-id="code-for-hybrid-model">Code for Hybrid Model</h4>
<div id="cell-29" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the categorical and continuous columns</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>cat_names <span class="op">=</span> [<span class="st">'UserID'</span>, <span class="st">'MovieID'</span>, <span class="st">'Gender'</span>, <span class="st">'Age'</span>, <span class="st">'OccupationID'</span>, <span class="st">'Zip-code'</span>]</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>cont_names <span class="op">=</span> all_genres</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>y_names <span class="op">=</span> <span class="st">'Rating'</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>y_range <span class="op">=</span> (<span class="fl">0.5</span>, <span class="fl">5.5</span>)  <span class="co"># Ratings are 1 to 5, with a small buffer</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-30" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a TabularPandas object for the training data</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>procs <span class="op">=</span> [Categorify, FillMissing, Normalize]  <span class="co"># Preprocessing steps</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>)(range_of(train_df))  <span class="co"># 80/20 split</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>to <span class="op">=</span> TabularPandas(</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    train_df,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    procs<span class="op">=</span>procs,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    cat_names<span class="op">=</span>cat_names,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    cont_names<span class="op">=</span>cont_names,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    y_names<span class="op">=</span>y_names,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    splits<span class="op">=</span>splits,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    y_block<span class="op">=</span>RegressionBlock()</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-31" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataLoaders</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> to.dataloaders(bs<span class="op">=</span><span class="dv">64</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a tabular learner</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> tabular_learner(</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    dls,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    layers<span class="op">=</span>[<span class="dv">200</span>, <span class="dv">100</span>],  <span class="co"># Two hidden layers</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    y_range<span class="op">=</span>y_range,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>rmse</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-32" class="cell" data-outputid="6e7b606c-96fc-43b4-fc66-8aadff264b05" data-execution_count="46">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find a good learning rate</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>SuggestedLRs(valley=0.004365158267319202)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Q8_code_files/figure-html/cell-17-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-33" class="cell" data-outputid="a347bd31-14b9-4b88-bf8b-399ae3cd232f" data-execution_count="47">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the model (using a learning rate, e.g., 1e-2, adjust based on lr_find)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>, <span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">_rmse</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.844334</td>
<td>0.852411</td>
<td>0.923262</td>
<td>01:46</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.779786</td>
<td>0.817290</td>
<td>0.904041</td>
<td>01:42</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.733219</td>
<td>0.807426</td>
<td>0.898569</td>
<td>01:41</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.683579</td>
<td>0.774480</td>
<td>0.880046</td>
<td>01:42</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.662992</td>
<td>0.767562</td>
<td>0.876106</td>
<td>01:40</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="cell-34" class="cell" data-outputid="bb4d1704-dbf6-4b95-d97c-14854d73fb0f" data-execution_count="48">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Make Predictions on Test Data ---</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a TabularPandas object for the test data</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>test_to <span class="op">=</span> to.new(test_df)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>test_to.process()</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a test DataLoader</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>test_dl <span class="op">=</span> dls.test_dl(test_to.items)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>preds, _ <span class="op">=</span> learn.get_preds(dl<span class="op">=</span>test_dl)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Round predictions to the nearest integer</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">'Rating'</span>] <span class="op">=</span> preds.<span class="bu">round</span>().<span class="bu">int</span>()</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the required columns for the output</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>output_df <span class="op">=</span> test_df[[<span class="st">'UserID'</span>, <span class="st">'MovieID'</span>, <span class="st">'Rating'</span>]]</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the predictions to Q8_output.csv</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>output_df.to_csv(<span class="st">'Q8_output.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Predictions saved to Q8_output.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Predictions saved to Q8_output.csv</code></pre>
</div>
</div>
</section>
<section id="explanation-of-the-hybrid-model" class="level4">
<h4 class="anchored" data-anchor-id="explanation-of-the-hybrid-model">Explanation of the Hybrid Model</h4>
<ol type="1">
<li><strong>TabularPandas</strong>:
<ul>
<li><code>cat_names</code>: Categorical variables (<code>UserID</code>, <code>MovieID</code>, <code>Gender</code>, <code>Age</code>, <code>OccupationID</code>, <code>Zipcode</code>) are embedded.</li>
<li><code>cont_names</code>: Genre binary columns are treated as continuous features.</li>
<li><code>y_names</code>: The target variable is <code>Rating</code>.</li>
<li><code>procs</code>: Preprocessing steps like <code>Categorify</code> (for categorical variables), <code>FillMissing</code>, and <code>Normalize</code> (for continuous variables).</li>
</ul></li>
<li><strong>DataLoaders</strong>:
<ul>
<li>Created a 80/20 train-validation split for training and evaluation.</li>
</ul></li>
<li><strong>tabular_learner</strong>:
<ul>
<li>Uses embeddings for categorical variables (e.g., <code>UserID</code>, <code>MovieID</code>, etc.).</li>
<li>Combines embeddings with continuous features (genres) in a neural network with two hidden layers (<code>[200, 100]</code>).</li>
<li><code>y_range=(0.5, 5.5)</code> constrains the output to the rating scale.</li>
</ul></li>
<li><strong>Training</strong>:
<ul>
<li>Trained for 5 epochs with a learning rate (assumed 1e-2, adjust based on <code>lr_find</code>).</li>
</ul></li>
<li><strong>Predictions</strong>:
<ul>
<li>Processed the test data using the same preprocessing pipeline.</li>
<li>Predicted ratings, rounded them to integers, and saved the output.</li>
</ul></li>
</ol>
</section>
<section id="updated-bonus-report" class="level4">
<h4 class="anchored" data-anchor-id="updated-bonus-report">Updated Bonus Report</h4>
<p><strong>Advantages of the Hybrid Model with FastAI</strong></p>
<ol type="1">
<li><strong>Incorporation of Additional Features</strong>: By including user features (<code>Age</code>, <code>Gender</code>, <code>OccupationID</code>, <code>Zipcode</code>) and movie features (<code>Genres</code>), the model captures more context about user preferences and movie characteristics, potentially improving prediction accuracy.</li>
<li><strong>Flexibility of FastAI</strong>: FastAI’s <code>tabular_learner</code> allows us to combine collaborative filtering (via <code>UserID</code> and <code>MovieID</code> embeddings) with content-based features (genres, user demographics) in a single model.</li>
<li><strong>Embedding for Categorical Variables</strong>: FastAI automatically creates embeddings for categorical variables, which helps in learning meaningful representations for <code>Age</code>, <code>OccupationID</code>, <code>Zipcode</code>, and <code>Gender</code>.</li>
<li><strong>Scalability</strong>: The model can handle both sparse user-item interactions and dense feature data (e.g., genres), making it scalable to larger datasets.</li>
<li><strong>Performance</strong>: The hybrid approach often outperforms pure collaborative filtering by leveraging additional information, as reflected in the RMSE (calculated above).</li>
</ol>
<p><strong>Comparison with State-of-the-Art Methods</strong></p>
<ol type="1">
<li><strong>Pure Collaborative Filtering</strong>: The previous approach (using <code>collab_learner</code>) relied solely on user-item interactions. The hybrid model improves on this by incorporating content-based features, which can help in cold-start scenarios (new users or movies).</li>
<li><strong>Neural Collaborative Filtering (NCF)</strong>: NCF uses a neural network for user-item interactions but doesn’t naturally incorporate side information. Our hybrid model extends this idea by adding user and movie features, making it more robust.</li>
<li><strong>Graph-Based Methods</strong>: Graph Neural Networks (GNNs) can model higher-order relationships but often don’t directly use content features like genres or demographics. Our hybrid model is simpler and directly leverages these features.</li>
<li><strong>State-of-the-Art Hybrid Methods</strong>: Advanced hybrid methods (e.g., DeepFM, Wide &amp; Deep) combine collaborative and content-based features using complex architectures. Our model is a simpler hybrid approach but still effective, as it uses embeddings and a neural network to combine features.</li>
</ol>
<p><strong>Conclusion</strong></p>
<p>The hybrid model with FastAI provides a practical and effective solution for this movie recommendation task. By incorporating user demographics and movie genres, it achieves a better RMSE (as calculated above) compared to pure collaborative filtering. While state-of-the-art methods like DeepFM might offer further improvements, they require more complex implementation. This hybrid approach strikes a good balance between performance and simplicity.</p>
</section>
</section>
<section id="final-notes" class="level3">
<h3 class="anchored" data-anchor-id="final-notes">Final Notes</h3>
<ul>
<li>The code assumes all CSV files are in the same directory.</li>
<li>The learning rate (1e-2) is a placeholder; use <code>learn.lr_find()</code> to find the optimal value.</li>
<li>The hybrid model leverages additional features, which should improve prediction accuracy, especially for users or movies with sparse interaction data.</li>
<li>If you have access to the ground truth ratings for <code>rating_test.csv</code>, you can compute the actual RMSE for the bonus score.</li>
</ul>
</section>
<section id="step-6-package-the-submission" class="level3">
<h3 class="anchored" data-anchor-id="step-6-package-the-submission">Step 6: Package the Submission</h3>
<p>We’ll submit the code, report, and output in a folder named <code>Q8</code>.</p>
</section>
<section id="step-7-write-the-report" class="level3">
<h3 class="anchored" data-anchor-id="step-7-write-the-report">Step 7: Write the Report</h3>
<p>The report (<code>Q8_readme.pdf</code>) should include the code and algorithm details.</p>
<section id="report-content" class="level4">
<h4 class="anchored" data-anchor-id="report-content">Report Content</h4>
<ol type="1">
<li><strong>Introduction</strong>:
<ul>
<li>The task is to predict movie ratings for the test set using a recommendation system.</li>
<li>Data includes user, movie, and rating information.</li>
</ul></li>
<li><strong>Algorithm Details</strong>:
<ul>
<li><strong>Basic Model</strong>:
<ul>
<li>Used Fastai’s <code>collab_learner</code> for collaborative filtering.</li>
<li>Learned latent factors for users and movies to predict ratings.</li>
<li>Trained for 5 epochs with 50 latent factors.</li>
</ul></li>
<li><strong>Enhanced Model</strong>:
<ul>
<li>Incorporated user features (Gender, Age, OccupationID) and movie features (Genres).</li>
<li>Created a custom model combining collaborative filtering embeddings with tabular features.</li>
<li>Used a neural network to combine features and predict ratings.</li>
</ul></li>
<li><strong>Prediction</strong>:
<ul>
<li>Predicted ratings for the test set and rounded them to the nearest integer in [1, 5].</li>
</ul></li>
</ul></li>
<li><strong>Results</strong>:
<ul>
<li><p>Output saved in <code>Q8_output.csv</code> with columns <code>UserID</code>, <code>MovieID</code>, <code>Rating</code>.</p></li>
<li><p>Example output (first 3 rows):</p>
<pre><code>UserID,MovieID,Rating
1,914,4
1,2018,3
1,2797,5</code></pre></li>
</ul></li>
<li><strong>Code</strong>:
<ul>
<li>[Include the entire code from above]</li>
</ul></li>
</ol>
</section>
</section>
<section id="final-submission" class="level3">
<h3 class="anchored" data-anchor-id="final-submission">Final Submission</h3>
<p>Your submission folder <code>Q8</code> should contain: - <code>Q8_readme.pdf</code>: The report with the code and algorithm details. - <code>Q8_output.csv</code>: The predicted ratings for the test set.</p>
<p><strong>Folder Structure</strong>:</p>
<pre><code>Q8/
├── Q8_readme.pdf
└── Q8_output.csv</code></pre>
<p>To create the PDF: 1. Copy the report content above into a document editor. 2. Include the actual output from <code>Q8_output.csv</code>. 3. Format it for clarity (e.g., use headings, bullet points). 4. Export the document as a PDF named <code>Q8_readme.pdf</code>. 5. Place the PDF and <code>Q8_output.csv</code> in the <code>Q8</code> folder.</p>
</section>
<section id="notes-and-potential-improvements" class="level3">
<h3 class="anchored" data-anchor-id="notes-and-potential-improvements">Notes and Potential Improvements</h3>
<ol type="1">
<li><strong>Feature Engineering</strong>: We used basic user and movie features. You could further improve by:
<ul>
<li>Extracting more features from timestamps (e.g., time of day, day of week).</li>
<li>Using movie titles for additional features (e.g., extracting keywords).</li>
</ul></li>
<li><strong>Model Architecture</strong>: The custom model is simple. You could add more layers or use a more complex architecture (e.g., attention mechanisms).</li>
<li><strong>Evaluation</strong>: Since no ground truth is provided for the test set, you could split the training data to evaluate the model’s performance (e.g., RMSE).</li>
</ol>
<p>If you need further assistance or want to explore alternative approaches, let me know!</p>
</section>
</section>
<section id="end" class="level1">
<h1>END</h1>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/twtang\.github\.io\/blog\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>